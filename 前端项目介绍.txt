web客户端交互逻辑
└── 模式选择（可选功能：账号系统）
    ├── 手动模式/专家模式
    │   ├── CT图像预处理
    │   │   ├── 打开图像（打开后先计算sha256，计算完成后上传服务端，服务端返回这个文件是否有被处理过）（多格式:png nii dicom npz）（打开非PNG时，先计算上传服务端，转换为PNG后返回客户端以供显示）
    │   │   ├── 图像转换（服务端实现）
    │   │   └── 图像增强（裁剪、缩放）（客户端处理PNG，服务端接受处理参数，处理nzp以供ai分析使用）
    │   ├── CT图像Ai分析【如果未完成预处理，则提示用户先进行预处理】
    │   │   ├── Ai图像分析（处理nzp，处理完成之后转为png发送客户端显示）
    │   │   └── Ai分析前后图像、人工标定图像三者之间对比（缩放锁定、x轴、y轴平移锁定、重置）（全部为客户端实现）
    │   ├── CT图像三维重建与分析【如果未完成预处理，则提示用户先进行预处理；如果未完成Ai分析，则只显示原始3D模型且无对比功能】
    │   │   ├── 显示多个（可选）三维模型并进行对比（缩放锁定、x轴、y轴、平移锁定、旋转锁定、重置）（全部为客户端实现）
    │   │   └── 一键显示
    │   └── 大模型问诊【结合所有之前的信息，同时带有RAG功能，可以管理RAG的相关文献，使用Qwen3-0.6b作为本地模型，支持API接入】
    │       └── 聊天界面（可以键盘输入或语音输入，可以提问之前的信息和RAG中的信息，如果提问不相干信息则委婉回拒）
    └── Ai模式
        ├── 聊天界面可以完成以上的所有流程，依靠ToDo List的节点）
        └── Todo List界面（引导用户的功能，同时为后台模型节点的前端提示，可Debug使用）

web端功能列表：
基础界面：
1.打开图像/显示图像界面（实际为上传），需要有上传提示进行占位（如果不是PNG，则也要进度包含上传与下载）
2.图像转换模块（若干个按钮，点击后转换为进度，服务端先传来最近10次转换的平均时间以供进度显示，进度条最多显示90%，当服务端处理完成后过渡到100%）
3.图像增强模块（客户端进行裁剪、缩放，并将对于图像的操作的参数传给服务端，服务端操作，点击保存后显示进度条，同上为最近10次时间）、
4.ai分析按钮，整体样式与打开图像类似，未分析时仅显示按钮（点击分析无需向服务端上传，使用服务端已有的内容）
5.图像对比功能（打开后，分析界面缩小为按钮，此界面从按钮放大为窗口）（纯客户端实现，与原始图像对比，缩放锁定、x轴、y轴平移锁定）
6.三维功能（目前不开发，仅占位）

ai界面：
1.聊天界面
2.ToDo List


web端开发流程
除Ai以外功能全部开发在一页中（基础界面），后续进行删减与分叉以便代码复用
Ai功能单独开发在Ai界面中（Ai界面），同上
主界面后续再开发（仅作route作用），框架界面后续再开发（界面导航，可以添加Log功能）

后端如何实现多文件的？
所有文件均使用XXH3进行索引，每次的请求也包含XXH3，后端文件夹直接使用xxh3命名

会用到的api：
基础界面：
/*下文为ai生成，目前未经审查

基础接口（基础界面）
- 全局说明
    - 所有涉及文件的请求需包含头部 X-XXH3: <xxh3-hash>（或表单字段 xxh3）。
    - 长任务均返回 task_id，可通过 /api/tasks/:taskId 查询或通过 /ws/tasks 推送进度。
    - 需要鉴权时使用 Authorization: Bearer <token>（账号系统可选）。

1) 上传/校验文件
- POST /api/files/upload
    - 描述：上传一个或多个文件（png/nii/dicom/npz 等）。服务端计算 sha256/xxh3并返回是否已处理过。
    - 请求：multipart/form-data files[]，可选字段 meta(JSON)。
    - 返回：
        { files: [{ xxh3, filename, size, processed:boolean, fileId }] }

- GET /api/files/:xxh3/status
    - 描述：查询文件元信息与处理状态。
    - 返回：
        { xxh3, processed, availableFormats:[png,nii,npz], previews:{pngUrl}, lastProcessedAt }

2) 文件转换（服务端转换，多次转换平均时间用于前端进度显示）
- POST /api/convert
    - 描述：发起格式转换（例如 nii/dicom/npz -> png）
    - 请求 JSON:
        { xxh3, targetFormat: "png", options:{slices, windowing,...} }
    - 返回:
        { taskId, recent10AvgMs }

- GET /api/tasks/:taskId
    - 描述：查询任务进度与状态
    - 返回:
        { taskId, status: "pending|running|done|failed", progressPct, recent10AvgMs, result:{xxh3, files:[...]}, error }

- GET /api/files/:xxh3/download?format=png
    - 描述：下载指定格式文件（供客户端显示或保存）

3) 图像增强（客户端裁剪/缩放参数传给服务端以便对 npz/nifti 等进行处理）
- POST /api/enhance/apply
    - 描述：提交增强参数并生成新文件/版本
    - 请求:
        { xxh3, ops:{crop:{x,y,w,h}, scale:0.8, rotate:...}, save:boolean }
    - 返回:
        { taskId, previewUrl, newXxh3 (若 save=true) }

4) AI分析流程（无需重新上传，使用服务端已有数据）。
- POST /api/ai/analyze
    - 描述：发起AI分析
    - 请求:
        { xxh3, model:"default", params:{thresholds,...}, options:{producePreview:true} }
    - 返回:
        { analysisId, taskId }

- GET /api/ai/results/:analysisId
    - 描述：获取分析结果（json + 预览图片链接）
    - 返回:
        { analysisId, status, result:{metrics, masks:[{slice,index,previewUrl}], reports, pngUrls } }

5) 三维重建（占位）
- POST /api/3d/reconstruct
    - 请求:
        { xxh3, params:{iso, smoothing,...} }
    - 返回:
        { taskId, modelIds:[id,...] }
- GET /api/3d/models/:modelId
    - 返回模型信息与下载/流式链接

6) 任务进度实时推送
- WebSocket /ws/tasks
    - 消息:
        { taskId, type:"progress|done|failed", progressPct, msg, data }

AI 接口（ai界面 / RAG / 聊天）
1) 会话与聊天
- POST /api/chat/session
    - 描述：创建或恢复会话
    - 请求:
        { sessionName, contextIds?:[] }
    - 返回:
        { sessionId }

- POST /api/chat/message
    - 描述：发送用户提问（支持文本或语音转文本）
    - 请求:
        { sessionId, message, useRag:true|false, ragDocIds?:[], preferLocalModel:true|false }
    - 返回:
        { messageId, replyTaskId, reply:{text?, streamingUrl?} }

- GET /api/chat/history?sessionId=...
    - 返回历史消息列表

- SSE/WebSocket /ws/chat?sessionId=...
    - 用于流式返回模型的增量回复（支持 Qwen3-0.6b 本地模型或外部API）

2) RAG（检索增强生成）相关
- POST /api/rag/docs
    - 描述：上传用于 RAG 的文献/片段（支持批量）
    - 请求：multipart/form-data file, fields: {xxh3, metadata}
    - 返回:
        { docId, insertedAt }

- GET /api/rag/docs
    - 描述：列举或搜索 RAG 文档
    - 请求参数: q, tag, page, size
    - 返回: hits [{docId, title, snippet, tags}]

- POST /api/rag/search
    - 描述：针对问题检索相关文档并返回候选摘要
    - 请求:
        { query, topK }
    - 返回:
        { results:[{docId,score,excerpt}] }

3) ToDo / 流程节点（用于 AI 模式自动执行流程）
- GET /api/todo?sessionId=...
    - 返回 TODO 节点列表
- POST /api/todo
    - 创建节点 { sessionId, title, type, payload }
- PUT /api/todo/:id
    - 更新节点（状态、结果、debug 信息）

4) 模型管理与降级
- GET /api/models
    - 列出可用模型（本地 Qwen3-0.6b、远程 API）
- POST /api/models/run
    - 请求:
        { modelId, sessionId, input, options }
    - 返回:
        { taskId / streamingUrl }

验收与 UI 行为说明（简要）
- 转换/增强/分析类任务：前端在收到 recent10AvgMs 时，用该平均时间渲染进度条（上限显示 90%），当 /api/tasks 返回 done 时立即过渡到 100% 并下载结果预览。
- 若文件未预处理（processed=false），ai/3d/分析接口应返回 400 + 明确错误码提示前端先完成预处理。
- 所有文件/任务接口均以 xxh3 为唯一索引，后端存储目录可直接用 xxh3 命名以便检索。

示例响应（分析请求成功示例）
{ analysisId:"a_123", taskId:"t_456", status:"queued", message:"analysis started" }
*/