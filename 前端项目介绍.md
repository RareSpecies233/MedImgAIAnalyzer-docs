# 前端项目介绍 ✅

> 本文档将把原始文本内容转换为结构化的 Markdown，包含 **交互逻辑、功能列表、开发流程、后端文件索引方案** 以及 **详细 API 说明**（示例与验收规范）。💡

---

## 目录
- [Web 客户端交互逻辑](#web-客户端交互逻辑)
- [Web 端功能列表](#web-端功能列表)
- [Web 端开发流程](#web-端开发流程)
- [后端文件索引与存储](#后端文件索引与存储)
- [会用到的 API 列表](#会用到的-api-列表)
- [验收与 UI 行为说明](#验收与-ui-行为说明)

---

## Web 客户端交互逻辑 🔧

### 模式选择（可选：账号系统）

- **手动模式 / 专家模式**
  - **CT 图像预处理**
    - 打开图像：打开时先计算 sha256（并上传服务端），服务端返回该文件是否已被处理过。
    - 支持多种格式：`png`, `nii`, `dicom`, `npz`。
    - 若不是 PNG：先上传计算、转换为 PNG，再返回客户端用于显示。
    - 图像转换：由服务端实现。
    - 图像增强（裁剪、缩放）：客户端对 PNG 处理并将参数发送服务端以处理 npz 作 AI 分析用。
  - **CT 图像 AI 分析**（若未完成预处理则提示先进行预处理）
    - AI 分析处理 npz，处理后转换为 png 供客户端显示。
    - 对比：AI 分析前后与人工标定图像三者对比（缩放锁定、X/Y 平移锁定、重置），全部在客户端实现。
  - **CT 图像三维重建与分析**（若未完成预处理则提示；若未完成 AI 分析则仅显示原始 3D 模型且无对比功能）
    - 显示多个可选 3D 模型并对比（缩放锁定、平移/旋转锁定、重置），全部客户端实现。
    - 支持“一键显示”。
  - **大模型问诊（RAG）**
    - 结合所有信息，带有 RAG 功能，管理相关文献。
    - 使用本地模型 Qwen3-0.6b 并支持 API 接入。
    - 聊天界面支持键盘输入或语音输入；可基于历史或 RAG 文档回答问题，不相关问题委婉回拒。

- **AI 模式**
  - 聊天界面可串联以上所有流程（依靠 ToDo List 节点执行）。
  - 提供 ToDo List 界面：引导用户并为后台模型提供前端提示，支持 Debug 使用。

---

## Web 端功能列表 🧭

### 基础界面：
1. **打开图像 / 显示图像界面**（实则为上传）：显示上传进度（若非 PNG 包含上传与下载进度）。
2. **图像转换模块**：若干按钮触发转换，服务端返回最近 10 次转换平均耗时用于进度显示；前端进度条最多显示 90%，服务端完成后过渡到 100%。
3. **图像增强模块**：客户端裁剪/缩放并将操作参数传给服务端，服务端处理（如保存），并显示与转换相同的进度策略。
4. **AI 分析按钮**：样式与打开图像类似；未分析时仅显示按钮。点击分析不需重新上传，使用服务端已有内容。
5. **图像对比功能**：打开后分析界面缩小为按钮；从按钮放大为窗口（纯客户端实现），支持缩放锁定与 X/Y 平移锁定。
6. **三维功能**：目前为占位，不开发。

### AI 界面：
- 聊天界面
- ToDo List

---

## Web 端开发流程 🛠️

- 除 AI 功能外，其余功能开发在 **一页**（基础界面），以便后续删减与分叉实现代码复用。
- AI 功能独立开发在 **AI 界面** 页面。
- 主界面（仅作路由）及框架导航页可后续再开发（可加日志功能）。

---

## 后端文件索引与存储 📁

- 所有文件使用 **XXH3** 进行索引。
- 每次请求应包含 XXH3（如请求头 `X-XXH3: <xxh3-hash>` 或表单字段 `xxh3`）。
- 后端文件夹直接使用 `xxh3` 命名，便于检索。

---

## 会用到的 API 列表 📡

> 以下接口与规范基于原始文档整理，示例均为参考实现。

### 全局约定
- 所有涉及文件的请求需包含头部：`X-XXH3: <xxh3-hash>`（或表单字段 `xxh3`）。
- 长任务返回 `task_id`，可通过 `/api/tasks/:taskId` 查询或 `/ws/tasks` 推送进度。
- 需要鉴权时使用：`Authorization: Bearer <token>`（账号系统可选）。

### 1) 上传 / 校验文件

- **POST /api/files/upload**
  - 描述：上传一个或多个文件（png/nii/dicom/npz 等）。服务端计算 sha256 / xxh3 并返回是否已处理过。
  - 请求：`multipart/form-data files[]`，可选字段 `meta`（JSON）。
  - 返回示例：

```json
{ "files": [{ "xxh3": "...", "filename": "x.png", "size": 1234, "processed": false, "fileId": "f_1" }] }
```

- **GET /api/files/:xxh3/status**
  - 描述：查询文件元信息与处理状态。
  - 返回示例：

```json
{ "xxh3": "...", "processed": true, "availableFormats": ["png","nii","npz"], "previews": { "pngUrl": "..." }, "lastProcessedAt": "..." }
```

---

### 2) 文件转换（服务端转换）

- **POST /api/convert**
  - 请求 JSON：

```json
{ "xxh3": "...", "targetFormat": "png", "options": { "slices": [], "windowing": {} } }
```

  - 返回：

```json
{ "taskId": "t_123", "recent10AvgMs": 12345 }
```

- **GET /api/tasks/:taskId**
  - 返回：

```json
{ "taskId": "t_123", "status": "running", "progressPct": 42, "recent10AvgMs": 12345, "result": { "xxh3": "...", "files": [] }, "error": null }
```

- **GET /api/files/:xxh3/download?format=png**
  - 描述：下载指定格式文件。

---

### 3) 图像增强

- **POST /api/enhance/apply**
  - 请求：

```json
{ "xxh3": "...", "ops": { "crop": { "x":0, "y":0, "w":100, "h":100 }, "scale": 0.8 }, "save": true }
```

  - 返回：

```json
{ "taskId": "t_789", "previewUrl": "...", "newXxh3": "..." }
```

---

### 4) AI 分析流程（使用服务端已有数据）

- **POST /api/ai/analyze**
  - 请求示例：

```json
{ "xxh3": "...", "model": "default", "params": { "thresholds": {} }, "options": { "producePreview": true } }
```

  - 返回：

```json
{ "analysisId": "a_123", "taskId": "t_456" }
```

- **GET /api/ai/results/:analysisId**
  - 返回示例：

```json
{ "analysisId": "a_123", "status": "done", "result": { "metrics": {}, "masks": [{ "slice": 12, "index": 1, "previewUrl": "..." }], "reports": {}, "pngUrls": ["..."] } }
```

---

### 5) 三维重建（占位）

- **POST /api/3d/reconstruct**
  - 请求：

```json
{ "xxh3": "...", "params": { "iso": 1.0, "smoothing": 0.5 } }
```

  - 返回：

```json
{ "taskId": "t_3d", "modelIds": ["m_1", "m_2"] }
```

- **GET /api/3d/models/:modelId**
  - 描述：返回模型信息与下载/流式链接。

---

### 6) 任务进度实时推送

- **WebSocket**: `/ws/tasks`
  - 消息示例：

```json
{ "taskId": "t_123", "type": "progress|done|failed", "progressPct": 50, "msg": "...", "data": {} }
```

---

## AI 接口（AI 界面 / RAG / 聊天）🤖

### 会话与聊天
- **POST /api/chat/session**
  - 创建或恢复会话：

```json
{ "sessionName": "...", "contextIds": [] }
```

- **POST /api/chat/message**
  - 发送用户提问（文本或语音转文本）：

```json
{ "sessionId": "s_1", "message": "...", "useRag": true, "ragDocIds": [], "preferLocalModel": true }
```

  - 返回示例：

```json
{ "messageId": "m_1", "replyTaskId": "t_r_1", "reply": { "text": "...", "streamingUrl": "..." } }
```

- **GET /api/chat/history?sessionId=...**：返回历史消息列表。
- **SSE/WebSocket /ws/chat?sessionId=...**：用于流式返回模型的增量回复（支持本地 Qwen3-0.6b 或外部 API）。

### RAG 相关
- **POST /api/rag/docs**：上传 RAG 文献/片段（multipart/form-data，字段 `xxh3, metadata`）。返回 `{ docId, insertedAt }`。
- **GET /api/rag/docs**：列举或搜索 RAG 文档（参数：q, tag, page, size）。
- **POST /api/rag/search**：检索文档并返回候选摘要。

### ToDo / 流程节点（用于 AI 模式自动执行流程）
- **GET /api/todo?sessionId=...**：返回 TODO 节点列表。
- **POST /api/todo**：创建节点 `{ sessionId, title, type, payload }`。
- **PUT /api/todo/:id**：更新节点状态/结果/调试信息。

### 模型管理
- **GET /api/models**：列出可用模型（如本地 Qwen3-0.6b 与远程 API）。
- **POST /api/models/run**：运行模型，返回 `taskId` 或 `streamingUrl`。

---

## 验收与 UI 行为说明 ✅

- 对于转换 / 增强 / 分析类任务：前端在收到 `recent10AvgMs` 时用该平均时间渲染进度条（上限显示 90%），当 `/api/tasks` 返回 `done` 时立即过渡到 100% 并下载结果预览。
- 若文件未预处理 (`processed=false`)，ai/3d/分析接口应返回 400 且包含明确错误码，提示前端先完成预处理。
- 所有文件与任务均以 `xxh3` 为唯一索引，后端存储目录可直接用 `xxh3` 命名以便检索。

示例响应（分析请求成功示例）：

```json
{ "analysisId": "a_123", "taskId": "t_456", "status": "queued", "message": "analysis started" }
```

---

> 如需我将该 Markdown 内容进一步拆分为更小的文档（例如：`API.md`、`流程.md`、`RAG.md`）或生成 TOC 链接与前端页面草图，我可以继续处理。🔧

---

*文件已生成： `前端项目介绍.md`*